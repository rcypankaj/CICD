name: React Native CI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - LICENSE
      - docs/**
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      buildType:
        type: choice
        description: Build type to run
        options: [prod-apk, all]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  NODE_OPTIONS: "--openssl-legacy-provider --max_old_space_size=4096"
  FORCE_COLOR: 1

jobs:
  # Skip job if commit message contains [skip ci]
  check-skip:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Skip CI check
        run: echo "Proceeding with workflow"

  # Test job with basic caching
  test:
    runs-on: ubuntu-latest
    needs: check-skip
    steps:
      - name: ðŸ—ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.3"
          cache: yarn

      - name: ðŸ“¦ Install dependencies
        run: |
          yarn install --frozen-lockfile --prefer-offline
          yarn add --dev babel-plugin-module-resolver

      - name: ðŸ§ª Run tests (if available)
        run: |
          if yarn run --json 2>/dev/null | grep -q '"test"'; then
            echo "Running tests..."
            yarn test
          else
            echo "No test script found, skipping tests"
          fi

  # Build and deploy job with safe caching
  build-and-deploy:
    needs: [check-skip, test]
    if: >-
      ((github.event_name == 'push' && contains(fromJson('["refs/heads/main", "refs/heads/master"]'), github.ref)) ||
      github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: ðŸ—ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.3"
          cache: yarn

      - name: ðŸ“¦ Get yarn cache directory
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - name: ðŸ—‚ï¸ Cache yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: ðŸ—‚ï¸ Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/yarn.lock', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: ðŸ—‚ï¸ Cache EAS local builds
        uses: actions/cache@v4
        with:
          path: ~/.eas-build-local
          key: ${{ runner.os }}-eas-local-${{ hashFiles('**/eas.json', '**/app.json') }}
          restore-keys: |
            ${{ runner.os }}-eas-local-

      - name: ðŸ“¦ Install dependencies & tools
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          yarn install --frozen-lockfile --prefer-offline
          yarn add --dev babel-plugin-module-resolver

      - name: ðŸ”§ Install EAS CLI
        run: |
          if ! command -v eas &> /dev/null; then
            npm install -g eas-cli@latest
          fi
          eas --version

      - name: ðŸ” Debug build environment
        run: |
          echo "ðŸ”§ Node: $(node -v)"
          echo "ðŸ“¦ Yarn: $(yarn -v)" 
          echo "ðŸ—ï¸ EAS: $(eas --version)"
          echo "ðŸ“„ Config files:"
          ls -la babel.config.js tsconfig.json eas.json app.json 2>/dev/null || echo "Some config files missing"
          echo "ðŸ“ Components:"
          ls -la components/ 2>/dev/null || echo "Components directory not found"

      - name: ðŸ” Setup build credentials
        run: |
          echo "Setting up build credentials..."
          echo "${CREDENTIALS_JSON_BASE64}" | base64 -d > credentials.json
          echo "${KEYSTORE_BASE64}" | base64 -d > keystore.jks
          ls -la credentials.json keystore.jks
        env:
          CREDENTIALS_JSON_BASE64: ${{ secrets.CREDENTIALS_JSON_BASE64 }}
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: ðŸ› ï¸ Build Production APK
        if: >-
          github.event.inputs.buildType == 'all' ||
          github.event.inputs.buildType == 'prod-apk' ||
          github.event_name == 'push'
        run: |
          echo "ðŸš€ Starting production APK build..."

          # Clean previous builds
          rm -f ./*.apk

          # Build APK
          eas build \
            --platform android \
            --profile production-apk \
            --local \
            --non-interactive \
            --output=./app-prod.apk \
            --clear-cache
            
          # Verify build
          if [ -f "./app-prod.apk" ]; then
            echo "âœ… APK build successful!"
            ls -lh ./app-prod.apk
            echo "ðŸ“Š APK size: $(du -h ./app-prod.apk | cut -f1)"
          else
            echo "âŒ APK build failed!"
            exit 1
          fi
        env:
          NODE_ENV: production
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: ðŸ“Š Build Summary
        if: success()
        run: |
          {
            echo "## ðŸŽ‰ Build Completed Successfully"
            echo ""
            echo "### ðŸ“± APK Details"
            echo "- **File:** app-prod.apk"
            echo "- **Size:** $(du -h ./app-prod.apk | cut -f1)"
            echo "- **Built:** $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Commit:** ${{ github.sha }}"
            echo ""
            echo "### ðŸ”— Download"
            echo "The APK will be available in the workflow artifacts."
          } >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: production-apk-${{ github.run_number }}
          path: ./app-prod.apk
          retention-days: 30

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f credentials.json keystore.jks
          echo "âœ… Cleanup completed"
